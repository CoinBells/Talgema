<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Talgema Run</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", Arial, sans-serif;
    }

    body {
      background: radial-gradient(circle at top, #222 0, #000 55%, #000 100%);
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      overflow: hidden;
      color: #222;
    }

    #game-wrapper {
      position: relative;
      width: 100%;
      max-width: 420px; /* مناسب للجوال */
      aspect-ratio: 9 / 16;
      background: #f5e4c8;
      border-radius: 24px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
      overflow: hidden;
    }

    canvas {
      width: 100%;
      height: 100%;
      display: block;
      background: linear-gradient(to bottom, #f7e8cf 0%, #f0dfc4 40%, #e3caa0 100%);
    }

    .screen {
      position: absolute;
      inset: 0;
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 20px;
      text-align: center;
      background: radial-gradient(circle at top, rgba(0, 0, 0, 0.25), rgba(0, 0, 0, 0.75));
      color: #f7f0e3;
    }

    .screen.visible {
      display: flex;
    }

    .title-ar {
      font-size: 32px;
      margin-bottom: 4px;
      letter-spacing: 1px;
    }

    .title-en {
      font-size: 18px;
      letter-spacing: 3px;
      text-transform: uppercase;
      margin-bottom: 12px;
      opacity: 0.9;
    }

    .subtitle {
      font-size: 13px;
      max-width: 90%;
      margin-bottom: 22px;
      opacity: 0.9;
    }

    .btn {
      background: #f5e4c8;
      color: #252220;
      border-radius: 999px;
      padding: 10px 22px;
      font-size: 15px;
      margin: 6px 0;
      border: none;
      cursor: pointer;
      font-weight: 600;
      letter-spacing: 0.5px;
      box-shadow: 0 8px 14px rgba(0, 0, 0, 0.35);
      transition: transform 0.1s ease, box-shadow 0.1s ease, background 0.15s;
    }

    .btn:active {
      transform: translateY(1px) scale(0.98);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
      background: #f1ddc0;
    }

    .btn-secondary {
      background: #2b2623;
      color: #f5e4c8;
      box-shadow: 0 6px 10px rgba(0, 0, 0, 0.4);
    }

    .btn-secondary:active {
      background: #211d1a;
    }

    .score-box {
      font-size: 14px;
      margin-top: 10px;
      opacity: 0.9;
    }

    /* شاشة اختيار السكن */
    #skin-list {
      display: flex;
      flex-direction: row;
      overflow-x: auto;
      gap: 10px;
      padding: 12px 4px;
      margin-bottom: 12px;
      width: 100%;
    }

    .skin-card {
      min-width: 110px;
      background: rgba(245, 228, 200, 0.95);
      border-radius: 18px;
      padding: 10px;
      color: #2b2623;
      box-shadow: 0 6px 10px rgba(0, 0, 0, 0.35);
      flex-shrink: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      font-size: 12px;
    }

    .skin-preview {
      width: 56px;
      height: 80px;
      border-radius: 16px;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
    }

    .skin-preview-body {
      width: 40px;
      height: 55px;
      border-radius: 14px;
      background: #d3b791;
      position: relative;
    }

    .skin-preview-head {
      position: absolute;
      top: -16px;
      left: 50%;
      transform: translateX(-50%);
      width: 26px;
      height: 26px;
      border-radius: 50%;
      background: #c49160;
    }

    .skin-preview-logo {
      position: absolute;
      bottom: 8px;
      left: 50%;
      transform: translateX(-50%);
      width: 32px;
      height: 10px;
      border-radius: 9px;
      background: rgba(0, 0, 0, 0.8);
    }

    .skin-name {
      font-weight: 600;
      margin-bottom: 3px;
    }

    .skin-note {
      font-size: 10px;
      opacity: 0.8;
      margin-bottom: 4px;
    }

    .skin-select-btn {
      border-radius: 999px;
      border: none;
      padding: 5px 10px;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      background: #2b2623;
      color: #f5e4c8;
    }

    .skin-select-btn.selected {
      background: #b68540;
      color: #fff7e9;
    }

    /* شريط السكور أثناء اللعب */
    #hud {
      position: absolute;
      top: 10px;
      left: 0;
      right: 0;
      display: flex;
      justify-content: space-between;
      padding: 0 14px;
      font-size: 13px;
      color: #2b2623;
      text-shadow: 0 1px 2px rgba(255,255,255,0.6);
      pointer-events: none;
    }

    #hint {
      position: absolute;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 11px;
      color: #3a332e;
      background: rgba(245, 228, 200, 0.8);
      padding: 4px 10px;
      border-radius: 999px;
      pointer-events: none;
    }
  </style>
</head>
<body>
  <div id="game-wrapper">
    <canvas id="gameCanvas"></canvas>

    <!-- HUD أثناء اللعب -->
    <div id="hud" style="display:none;">
      <div id="scoreLabel">Score: 0</div>
      <div id="bestLabel">Best: 0</div>
    </div>
    <div id="hint" style="display:none;">Tap to jump – tap again for double jump</div>

    <!-- شاشة البداية -->
    <div id="startScreen" class="screen visible">
      <div class="title-ar">تلقيمة</div>
      <div class="title-en">TALGEMA RUN</div>
      <div class="subtitle">
        عامل الفرن يجهز الفطاير، وأنت تهرب من العوائق وتجمع الكرك والفطاير
        إلى أن يجهز طلبك.
      </div>
      <button id="startBtn" class="btn">ابدأ اللعب</button>
      <div class="score-box">
        أفضل نتيجة: <span id="startBestScore">0</span>
      </div>
    </div>

    <!-- شاشة اختيار السكن -->
    <div id="skinScreen" class="screen">
      <div class="title-en">Choose Your Baker</div>
      <div class="subtitle">
        اختر بدلة عامل الفرن قبل أن تبدأ الجري داخل مخبز تلقيمة.
      </div>
      <div id="skin-list"></div>
      <button id="skinPlayBtn" class="btn">ابدأ الجري</button>
      <button id="skinBackBtn" class="btn btn-secondary">رجوع</button>
    </div>

    <!-- شاشة النتيجة -->
    <div id="gameOverScreen" class="screen">
      <div class="title-en">Order Almost Ready</div>
      <div class="subtitle">
        انتهى الجري، لكن الفطور على وشك أن يجهز. العب جولة جديدة وأكسر الرقم.
      </div>
      <div class="score-box">
        نتيجتك: <span id="finalScore">0</span><br/>
        أفضل نتيجة: <span id="finalBestScore">0</span>
      </div>
      <button id="retryBtn" class="btn">جولة جديدة</button>
      <button id="homeBtn" class="btn btn-secondary">الرجوع للرئيسية</button>
    </div>
  </div>

  <script>
    // ===================== إعداد الكانفس =====================
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");

    const GAME_WIDTH = 360;
    const GAME_HEIGHT = 640;
    canvas.width = GAME_WIDTH;
    canvas.height = GAME_HEIGHT;

    // ===================== تحميل صورة العامل =====================
    const bakerImg = new Image();
    bakerImg.src = "BAKER.PNG"; // الاسم بحروف كبيرة
    let bakerLoaded = false;
    bakerImg.onload = () => {
      bakerLoaded = true;
    };

    // ===================== عناصر الواجهة =====================
    const startScreen = document.getElementById("startScreen");
    const skinScreen = document.getElementById("skinScreen");
    const gameOverScreen = document.getElementById("gameOverScreen");
    const startBtn = document.getElementById("startBtn");
    const skinPlayBtn = document.getElementById("skinPlayBtn");
    const skinBackBtn = document.getElementById("skinBackBtn");
    const retryBtn = document.getElementById("retryBtn");
    const homeBtn = document.getElementById("homeBtn");
    const hud = document.getElementById("hud");
    const hint = document.getElementById("hint");
    const scoreLabel = document.getElementById("scoreLabel");
    const bestLabel = document.getElementById("bestLabel");
    const startBestScoreLabel = document.getElementById("startBestScore");
    const finalScoreLabel = document.getElementById("finalScore");
    const finalBestScoreLabel = document.getElementById("finalBestScore");
    const skinList = document.getElementById("skin-list");

    // ===================== حالة اللعبة =====================
    const STATE_MENU = "menu";
    const STATE_SKIN = "skin";
    const STATE_PLAYING = "playing";
    const STATE_GAMEOVER = "gameover";
    let gameState = STATE_MENU;

    // ===================== السكور =====================
    let score = 0;
    const BEST_KEY = "talgema_run_best_score";
    let bestScore = parseInt(localStorage.getItem(BEST_KEY) || "0", 10);

    // ===================== السكنات =====================
    const skins = [
      {
        id: "classic",
        name: "Classic Baker",
        note: "بدلة البيج الكلاسيكية مع شعار تلقيمة.",
      },
      {
        id: "karak",
        name: "Karak Master",
        note: "لمسة كرك على المريول (اسمياً داخل اللعبة).",
      },
      {
        id: "flame",
        name: "Oven Flame",
        note: "إحساس انعكاس نار الفرن (اسمياً).",
      },
      {
        id: "midnight",
        name: "Midnight Baker",
        note: "جو ليلي وإضاءة ناعمة (اسمياً).",
      },
      {
        id: "golden",
        name: "Golden Talgema",
        note: "سكن مميز بإحساس ذهبي.",
      }
    ];

    let selectedSkinId = "classic";

    function buildSkinCards() {
      skinList.innerHTML = "";
      skins.forEach((skin) => {
        const card = document.createElement("div");
        card.className = "skin-card";

        const preview = document.createElement("div");
        preview.className = "skin-preview";
        preview.style.background = "#f3dfc1";

        const body = document.createElement("div");
        body.className = "skin-preview-body";

        const head = document.createElement("div");
        head.className = "skin-preview-head";

        const logo = document.createElement("div");
        logo.className = "skin-preview-logo";

        preview.appendChild(body);
        preview.appendChild(head);
        preview.appendChild(logo);

        const name = document.createElement("div");
        name.className = "skin-name";
        name.textContent = skin.name;

        const note = document.createElement("div");
        note.className = "skin-note";
        note.textContent = skin.note;

        const btn = document.createElement("button");
        btn.className = "skin-select-btn";
        btn.textContent = "اختر";

        if (skin.id === selectedSkinId) {
          btn.classList.add("selected");
          btn.textContent = "مختار";
        }

        btn.addEventListener("click", () => {
          selectedSkinId = skin.id;
          document.querySelectorAll(".skin-select-btn").forEach((b) => {
            b.classList.remove("selected");
            b.textContent = "اختر";
          });
          btn.classList.add("selected");
          btn.textContent = "مختار";
        });

        card.appendChild(preview);
        card.appendChild(name);
        card.appendChild(note);
        card.appendChild(btn);
        skinList.appendChild(card);
      });
    }

    // ===================== اللاعب والعناصر =====================
    const groundY = GAME_HEIGHT - 110;

    const player = {
      x: 90,
      y: groundY - 80,
      width: 42,
      height: 80,
      vy: 0,
      onGround: true,
      canDoubleJump: true
    };

    const gravity = 0.6;
    const jumpVelocity = -11;

    const obstacles = [];
    const pickups = [];

    let lastSpawnObstacle = 0;
    let lastSpawnPickup = 0;
    let obstacleInterval = 1400;
    let pickupInterval = 1000;

    let lastFrameTime = performance.now();

    function randRange(min, max) {
      return Math.random() * (max - min) + min;
    }

    // ===================== التحكم =====================
    let lastTapTime = 0;

    function handleInput() {
      if (gameState !== STATE_PLAYING) return;

      const now = performance.now();
      const deltaTap = now - lastTapTime;
      lastTapTime = now;

      if (player.onGround) {
        player.vy = jumpVelocity;
        player.onGround = false;
        player.canDoubleJump = true;
      } else if (player.canDoubleJump && deltaTap < 350) {
        player.vy = jumpVelocity;
        player.canDoubleJump = false;
      }
    }

    canvas.addEventListener("touchstart", function (e) {
      e.preventDefault();
      handleInput();
    });

    canvas.addEventListener("mousedown", function (e) {
      e.preventDefault();
      handleInput();
    });

    // ===================== دوال رسم =====================
    function drawBackground() {
      ctx.fillStyle = "#e1c296";
      ctx.fillRect(0, groundY, GAME_WIDTH, GAME_HEIGHT - groundY);

      ctx.fillStyle = "#d1b494";
      ctx.beginPath();
      ctx.arc(310, groundY - 40, 60, Math.PI, 0);
      ctx.fill();

      ctx.fillStyle = "#5a4634";
      ctx.beginPath();
      ctx.arc(310, groundY - 15, 30, Math.PI, 0);
      ctx.fill();

      const gradient = ctx.createRadialGradient(
        310,
        groundY - 10,
        5,
        310,
        groundY - 10,
        35
      );
      gradient.addColorStop(0, "#ffecb3");
      gradient.addColorStop(0.3, "#ffb74d");
      gradient.addColorStop(1, "rgba(255, 183, 77, 0)");
      ctx.fillStyle = gradient;
      ctx.beginPath();
      ctx.arc(310, groundY - 10, 36, 0, Math.PI * 2);
      ctx.fill();

      ctx.fillStyle = "#c4a37d";
      ctx.fillRect(0, groundY - 22, 130, 10);
      ctx.fillStyle = "#9f7e58";
      ctx.fillRect(15, groundY - 12, 10, 22);
      ctx.fillRect(95, groundY - 12, 10, 22);
    }

    function drawPlayer() {
      // ظل بسيط
      ctx.fillStyle = "rgba(0,0,0,0.25)";
      ctx.beginPath();
      ctx.ellipse(
        player.x + player.width / 2,
        groundY + 4,
        22,
        6,
        0,
        0,
        Math.PI * 2
      );
      ctx.fill();

      if (bakerLoaded) {
        const spriteWidth = 150;
        const spriteHeight = 210;
        const drawX = player.x - (spriteWidth - player.width) / 2;
        const drawY = groundY - spriteHeight;
        ctx.drawImage(bakerImg, drawX, drawY, spriteWidth, spriteHeight);
      } else {
        // احتياطي لو الصورة ما تحملت
        ctx.fillStyle = "#d3b791";
        ctx.fillRect(player.x, player.y, player.width, player.height);
      }
    }

    function drawObstacle(ob) {
      ctx.fillStyle = ob.color;
      roundRect(ctx, ob.x, ob.y, ob.width, ob.height, 6);
      ctx.fill();

      ctx.fillStyle = "rgba(0,0,0,0.18)";
      if (ob.type === "tray") {
        ctx.fillRect(ob.x + 6, ob.y + 6, ob.width - 12, 6);
      } else if (ob.type === "olive") {
        ctx.beginPath();
        ctx.arc(
          ob.x + ob.width / 2,
          ob.y + ob.height / 2,
          ob.width / 2.4,
          0,
          Math.PI * 2
        );
        ctx.fill();
      } else if (ob.type === "flour") {
        ctx.fillRect(ob.x + 4, ob.y + 4, ob.width - 8, ob.height - 10);
      }
    }

    function drawPickup(pk) {
      const centerX = pk.x + pk.size / 2;
      const centerY = pk.y + pk.size / 2;

      if (pk.kind === "karak") {
        ctx.fillStyle = "#f7f0e3";
        roundRect(ctx, centerX - 10, centerY - 14, 20, 22, 4);
        ctx.fill();

        ctx.fillStyle = "#c58a4a";
        ctx.fillRect(centerX - 8, centerY - 10, 16, 14);

        ctx.fillStyle = "#b3956c";
        ctx.fillRect(centerX - 6, centerY + 8, 12, 3);
      } else {
        ctx.fillStyle = "#f1d2a4";
        ctx.beginPath();
        ctx.ellipse(centerX, centerY, 15, 10, 0, 0, Math.PI * 2);
        ctx.fill();

        ctx.fillStyle = "#d08b3f";
        ctx.beginPath();
        ctx.ellipse(centerX, centerY, 10, 6, 0, 0, Math.PI * 2);
        ctx.fill();
      }
    }

    function roundRect(ctx, x, y, w, h, r) {
      if (w < 2 * r) r = w / 2;
      if (h < 2 * r) r = h / 2;
      ctx.beginPath();
      ctx.moveTo(x + r, y);
      ctx.arcTo(x + w, y, x + w, y + h, r);
      ctx.arcTo(x + w, y + h, x, y + h, r);
      ctx.arcTo(x, y + h, x, y, r);
      ctx.arcTo(x, y, x + w, y, r);
      ctx.closePath();
      return ctx;
    }

    // ===================== لوجيك اللعبة =====================
    function resetGame() {
      score = 0;
      player.x = 90;
      player.y = groundY - 80;
      player.vy = 0;
      player.onGround = true;
      player.canDoubleJump = true;
      obstacles.length = 0;
      pickups.length = 0;
      lastSpawnObstacle = 0;
      lastSpawnPickup = 0;
      obstacleInterval = 1400;
      pickupInterval = 1000;
      lastFrameTime = performance.now();
      scoreLabel.textContent = "Score: 0";
      bestLabel.textContent = "Best: " + bestScore;
    }

    function spawnObstacle(now) {
      const typeRoll = Math.random();
      let type = "tray";
      let width = 55;
      let height = 35;
      let color = "#b27d51";

      if (typeRoll < 0.33) {
        type = "olive";
        width = 30;
        height = 30;
        color = "#8a9c4a";
      } else if (typeRoll < 0.66) {
        type = "flour";
        width = 46;
        height = 40;
        color = "#d2c6b3";
      }

      const ob = {
        x: GAME_WIDTH + 20,
        y: groundY - height,
        width,
        height,
        speed: 4.2,
        type,
        color
      };
      obstacles.push(ob);
      lastSpawnObstacle = now;
    }

    function spawnPickup(now) {
      const kind = Math.random() < 0.5 ? "karak" : "fatayer";
      const size = 26;
      const y = groundY - 80 - Math.random() * 60;

      const pk = {
        x: GAME_WIDTH + 20,
        y,
        size,
        speed: 4.2,
        kind
      };
      pickups.push(pk);
      lastSpawnPickup = now;
    }

    function rectsOverlap(ax, ay, aw, ah, bx, by, bw, bh) {
      return (
        ax < bx + bw &&
        ax + aw > bx &&
        ay < by + bh &&
        ay + ah > by
      );
    }

    function update(dt, now) {
      player.vy += gravity;
      player.y += player.vy;

      if (player.y + player.height >= groundY) {
        player.y = groundY - player.height;
        player.vy = 0;
        if (!player.onGround) {
          player.onGround = true;
          player.canDoubleJump = true;
        }
      }

      if (now - lastSpawnObstacle > obstacleInterval) {
        spawnObstacle(now);
        if (obstacleInterval > 900) {
          obstacleInterval -= 20;
        }
      }

      if (now - lastSpawnPickup > pickupInterval) {
        spawnPickup(now);
        if (pickupInterval > 700) {
          pickupInterval -= 10;
        }
      }

      for (let i = obstacles.length - 1; i >= 0; i--) {
        const ob = obstacles[i];
        ob.x -= ob.speed;
        if (ob.x + ob.width < -40) {
          obstacles.splice(i, 1);
        } else if (
          rectsOverlap(
            player.x,
            player.y,
            player.width,
            player.height,
            ob.x,
            ob.y,
            ob.width,
            ob.height
          )
        ) {
          gameOver();
          return;
        }
      }

      for (let i = pickups.length - 1; i >= 0; i--) {
        const pk = pickups[i];
        pk.x -= pk.speed;
        if (pk.x + pk.size < -30) {
          pickups.splice(i, 1);
        } else if (
          rectsOverlap(
            player.x,
            player.y,
            player.width,
            player.height,
            pk.x,
            pk.y,
            pk.size,
            pk.size
          )
        ) {
          score += pk.kind === "karak" ? 7 : 5;
          pickups.splice(i, 1);
          scoreLabel.textContent = "Score: " + score;
          if (score > bestScore) {
            bestScore = score;
            bestLabel.textContent = "Best: " + bestScore;
          }
        }
      }

      score += dt * 0.004;
      score = Math.floor(score);
      scoreLabel.textContent = "Score: " + score;
      if (score > bestScore) {
        bestScore = score;
        bestLabel.textContent = "Best: " + bestScore;
      }
    }

    function render() {
      ctx.clearRect(0, 0, GAME_WIDTH, GAME_HEIGHT);
      drawBackground();
      pickups.forEach(drawPickup);
      obstacles.forEach(drawObstacle);
      drawPlayer();
    }

    function loop(now) {
      if (gameState === STATE_PLAYING) {
        const dt = now - lastFrameTime;
        lastFrameTime = now;

        update(dt, now);
        render();
      } else {
        ctx.clearRect(0, 0, GAME_WIDTH, GAME_HEIGHT);
        drawBackground();
        drawPlayer();
      }

      requestAnimationFrame(loop);
    }

    // ===================== الشاشات =====================
    function showScreen(screen) {
      [startScreen, skinScreen, gameOverScreen].forEach((s) =>
        s.classList.remove("visible")
      );
      if (screen) screen.classList.add("visible");
    }

    function showHUD(show) {
      hud.style.display = show ? "flex" : "none";
      hint.style.display = show ? "block" : "none";
    }

    function goToMenu() {
      gameState = STATE_MENU;
      showScreen(startScreen);
      showHUD(false);
      startBestScoreLabel.textContent = bestScore;
    }

    function goToSkinSelect() {
      gameState = STATE_SKIN;
      buildSkinCards();
      showScreen(skinScreen);
      showHUD(false);
    }

    function startPlaying() {
      resetGame();
      gameState = STATE_PLAYING;
      showScreen(null);
      showHUD(true);
    }

    function gameOver() {
      gameState = STATE_GAMEOVER;
      showHUD(false);
      localStorage.setItem(BEST_KEY, bestScore.toString());
      finalScoreLabel.textContent = score;
      finalBestScoreLabel.textContent = bestScore;
      showScreen(gameOverScreen);
    }

    // ===================== ربط الأزرار =====================
    startBtn.addEventListener("click", () => {
      goToSkinSelect();
    });

    skinBackBtn.addEventListener("click", () => {
      goToMenu();
    });

    skinPlayBtn.addEventListener("click", () => {
      startPlaying();
    });

    retryBtn.addEventListener("click", () => {
      startPlaying();
    });

    homeBtn.addEventListener("click", () => {
      goToMenu();
    });

    // بدء الحلقة
    startBestScoreLabel.textContent = bestScore;
    requestAnimationFrame(loop);
  </script>
</body>
</html>
