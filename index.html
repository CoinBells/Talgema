<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Talgema Run</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", Arial, sans-serif;
    }

    body {
      background: radial-gradient(circle at top, #222 0, #000 55%, #000 100%);
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      overflow: hidden;
      color: #222;
    }

    #game-wrapper {
      position: relative;
      width: 100%;
      max-width: 420px;
      aspect-ratio: 9 / 16;
      background: #f5e4c8;
      border-radius: 24px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
      overflow: hidden;
    }

    canvas {
      width: 100%;
      height: 100%;
      display: block;
      background: transparent;
    }

    .screen {
      position: absolute;
      inset: 0;
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 20px;
      text-align: center;
      background: radial-gradient(circle at top, rgba(0, 0, 0, 0.25), rgba(0, 0, 0, 0.8));
      color: #f7f0e3;
    }

    .screen.visible {
      display: flex;
    }

    /* شاشة البداية */
    #logoMain {
      width: 190px;
      max-width: 70%;
      height: auto;
      border-radius: 50%;
      box-shadow: 0 10px 25px rgba(0,0,0,0.45);
      margin-bottom: 18px;
    }

    .title-en-small {
      font-size: 13px;
      letter-spacing: 4px;
      text-transform: uppercase;
      margin-bottom: 8px;
      opacity: 0.85;
    }

    .btn {
      background: #f5e4c8;
      color: #252220;
      border-radius: 999px;
      padding: 10px 26px;
      font-size: 15px;
      margin: 10px 0 4px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      letter-spacing: 1px;
      box-shadow: 0 8px 14px rgba(0, 0, 0, 0.35);
      transition: transform 0.1s ease, box-shadow 0.1s ease, background 0.15s;
    }

    .btn:active {
      transform: translateY(1px) scale(0.98);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
      background: #f1ddc0;
    }

    .btn-secondary {
      background: #2b2623;
      color: #f5e4c8;
      box-shadow: 0 6px 10px rgba(0, 0, 0, 0.4);
    }

    .btn-secondary:active {
      background: #211d1a;
    }

    .score-box {
      font-size: 13px;
      margin-top: 8px;
      opacity: 0.9;
    }

    /* HUD أثناء اللعب */
    #hud {
      position: absolute;
      top: 10px;
      left: 0;
      right: 0;
      display: flex;
      justify-content: space-between;
      padding: 0 14px;
      font-size: 13px;
      color: #2b2623;
      text-shadow: 0 1px 2px rgba(255,255,255,0.6);
      pointer-events: none;
    }

    #hint {
      position: absolute;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 11px;
      color: #3a332e;
      background: rgba(245, 228, 200, 0.9);
      padding: 4px 10px;
      border-radius: 999px;
      pointer-events: none;
    }

    /* صورة اللاعب في شاشة النتيجة */
    #bakerThumb {
      position: absolute;
      bottom: 40px;
      left: 26px;
      width: 90px;
      opacity: 0.95;
    }
  </style>
</head>
<body>
  <div id="game-wrapper">
    <canvas id="gameCanvas"></canvas>

    <!-- HUD أثناء اللعب -->
    <div id="hud" style="display:none;">
      <div id="scoreLabel">Score: 0</div>
      <div id="bestLabel">Best: 0</div>
    </div>
    <div id="hint" style="display:none;">اضغط على الشاشة للقفز (مرة ثانية لقفزة ثانية)</div>

    <!-- شاشة البداية -->
    <div id="startScreen" class="screen visible">
      <img id="logoMain" src="LOGO.PNG" alt="Talgema Logo" />
      <div class="title-en-small">TALGEMA RUN</div>
      <button id="startBtn" class="btn">START</button>
      <div class="score-box">
        BEST SCORE: <span id="startBestScore">0</span>
      </div>
    </div>

    <!-- شاشة النتيجة -->
    <div id="gameOverScreen" class="screen">
      <div class="title-en-small">ORDER ALMOST READY</div>
      <div class="score-box" style="margin-bottom:14px;">
        نتيجتك: <span id="finalScore">0</span><br/>
        أفضل نتيجة: <span id="finalBestScore">0</span>
      </div>
      <button id="retryBtn" class="btn">جولة جديدة</button>
      <button id="homeBtn" class="btn btn-secondary">الرجوع للرئيسية</button>
      <img id="bakerThumb" src="BAKER.PNG" alt="Baker" />
    </div>
  </div>

  <script>
    // ===================== إعداد الكانفس بدقة عالية =====================
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");

    const GAME_WIDTH = 360;
    const GAME_HEIGHT = 640;

    const dpr = window.devicePixelRatio || 1;
    canvas.width = GAME_WIDTH * dpr;
    canvas.height = GAME_HEIGHT * dpr;
    canvas.style.width = GAME_WIDTH + "px";
    canvas.style.height = GAME_HEIGHT + "px";
    ctx.scale(dpr, dpr);

    // ===================== تحميل الصور =====================
    const bakerImg = new Image();
    bakerImg.src = "BAKER.PNG";
    let bakerLoaded = false;
    bakerImg.onload = () => bakerLoaded = true;

    const karakImg = new Image();
    karakImg.src = "KARAK.PNG";
    let karakLoaded = false;
    karakImg.onload = () => karakLoaded = true;

    const fatayerImg = new Image();
    fatayerImg.src = "fatayer.jpg";

    // ===================== عناصر الواجهة =====================
    const wrapper = document.getElementById("game-wrapper");
    const startScreen = document.getElementById("startScreen");
    const gameOverScreen = document.getElementById("gameOverScreen");
    const startBtn = document.getElementById("startBtn");
    const retryBtn = document.getElementById("retryBtn");
    const homeBtn = document.getElementById("homeBtn");
    const hud = document.getElementById("hud");
    const hint = document.getElementById("hint");
    const scoreLabel = document.getElementById("scoreLabel");
    const bestLabel = document.getElementById("bestLabel");
    const startBestScoreLabel = document.getElementById("startBestScore");
    const finalScoreLabel = document.getElementById("finalScore");
    const finalBestScoreLabel = document.getElementById("finalBestScore");

    // ===================== حالة اللعبة =====================
    const STATE_MENU = "menu";
    const STATE_PLAYING = "playing";
    const STATE_GAMEOVER = "gameover";
    let gameState = STATE_MENU;

    // ===================== السكور =====================
    let score = 0;
    const BEST_KEY = "talgema_run_best_score";
    let bestScore = parseInt(localStorage.getItem(BEST_KEY) || "0", 10);

    // ===================== اللاعب والعناصر =====================
    const groundY = GAME_HEIGHT - 120;

    const player = {
      x: 90,
      y: groundY - 70,
      width: 38,
      height: 70,
      vy: 0,
      onGround: true,
      canDoubleJump: true
    };

    const gravity = 0.6;
    const jumpVelocity = -11;

    const obstacles = [];
    const pickups = [];

    let lastSpawnObstacle = 0;
    let lastSpawnPickup = 0;
    let obstacleInterval = 1400;
    let pickupInterval = 1000;

    let lastFrameTime = performance.now();

    // ===================== الإدخال (القفز) =====================
    function jump() {
      if (gameState !== STATE_PLAYING) return;

      if (player.onGround) {
        player.vy = jumpVelocity;
        player.onGround = false;
        player.canDoubleJump = true;
      } else if (player.canDoubleJump) {
        player.vy = jumpVelocity;
        player.canDoubleJump = false;
      }
    }

    function onPointerDown(e) {
      e.preventDefault();
      jump();
    }

    canvas.addEventListener("touchstart", onPointerDown, { passive: false });
    canvas.addEventListener("mousedown", onPointerDown);
    wrapper.addEventListener("touchstart", (e) => {
      if (gameState === STATE_PLAYING) {
        e.preventDefault();
        jump();
      }
    }, { passive: false });

    window.addEventListener("keydown", (e) => {
      if (e.code === "Space") jump();
    });

    // ===================== دوال رسم =====================
    function drawBackground() {
      ctx.fillStyle = "#f3e0c3";
      ctx.fillRect(0, 0, GAME_WIDTH, GAME_HEIGHT);

      // بوستر الفطاير بخفة في الخلفية
      if (fatayerImg.complete && fatayerImg.naturalWidth > 0) {
        ctx.save();
        ctx.globalAlpha = 0.18;
        const scale = GAME_WIDTH / fatayerImg.width;
        const h = fatayerImg.height * scale;
        ctx.drawImage(fatayerImg, 0, GAME_HEIGHT - h - 40, GAME_WIDTH, h);
        ctx.restore();
      }

      // نصوص كبيرة باهتة
      ctx.fillStyle = "rgba(80,70,60,0.18)";
      ctx.font = "bold 54px 'Georgia', serif";
      ctx.fillText("TRADITION", -10, 120);
      ctx.fillText("WARMTH", 10, 220);
      ctx.fillText("MEMORIES", -20, 320);

      // أرضية
      ctx.fillStyle = "#e1c296";
      ctx.fillRect(0, groundY, GAME_WIDTH, GAME_HEIGHT - groundY);
    }

    function drawPlayer() {
      // ظل
      ctx.fillStyle = "rgba(0,0,0,0.22)";
      ctx.beginPath();
      ctx.ellipse(
        player.x + player.width / 2,
        groundY + 4,
        18,
        6,
        0,
        0,
        Math.PI * 2
      );
      ctx.fill();

      if (bakerLoaded) {
        const spriteHeight = 190;
        const spriteWidth = spriteHeight * (bakerImg.width / bakerImg.height);
        const drawX = player.x - (spriteWidth - player.width) / 2;
        const drawY = groundY - spriteHeight;
        ctx.drawImage(bakerImg, drawX, drawY, spriteWidth, spriteHeight);
      } else {
        ctx.fillStyle = "#d3b791";
        ctx.fillRect(player.x, player.y, player.width, player.height);
      }
    }

    function drawObstacle(ob) {
      ctx.fillStyle = ob.color;
      roundRect(ctx, ob.x, ob.y, ob.width, ob.height, 8);
      ctx.fill();

      ctx.fillStyle = "rgba(0,0,0,0.15)";
      if (ob.type === "tray") {
        ctx.fillRect(ob.x + 6, ob.y + 6, ob.width - 12, 6);
      } else if (ob.type === "olive") {
        ctx.beginPath();
        ctx.arc(
          ob.x + ob.width / 2,
          ob.y + ob.height / 2,
          ob.width / 2.4,
          0,
          Math.PI * 2
        );
        ctx.fill();
      } else if (ob.type === "flour") {
        ctx.fillRect(ob.x + 4, ob.y + 4, ob.width - 8, ob.height - 10);
      }
    }

    function drawPickup(pk) {
      const size = pk.size;
      if (pk.kind === "karak" && karakLoaded) {
        ctx.drawImage(karakImg, pk.x, pk.y, size, size);
      } else {
        // فطيرة صغيرة
        const centerX = pk.x + size / 2;
        const centerY = pk.y + size / 2;
        ctx.fillStyle = "#f1d2a4";
        ctx.beginPath();
        ctx.ellipse(centerX, centerY, 15, 10, 0, 0, Math.PI * 2);
        ctx.fill();

        ctx.fillStyle = "#d08b3f";
        ctx.beginPath();
        ctx.ellipse(centerX, centerY, 10, 6, 0, 0, Math.PI * 2);
        ctx.fill();
      }
    }

    function roundRect(ctx, x, y, w, h, r) {
      if (w < 2 * r) r = w / 2;
      if (h < 2 * r) r = h / 2;
      ctx.beginPath();
      ctx.moveTo(x + r, y);
      ctx.arcTo(x + w, y, x + w, y + h, r);
      ctx.arcTo(x + w, y + h, x, y + h, r);
      ctx.arcTo(x, y + h, x, y, r);
      ctx.arcTo(x, y, x + w, y, r);
      ctx.closePath();
      return ctx;
    }

    // ===================== لوجيك اللعبة =====================
    function resetGame() {
      score = 0;
      player.x = 90;
      player.y = groundY - 70;
      player.vy = 0;
      player.onGround = true;
      player.canDoubleJump = true;
      obstacles.length = 0;
      pickups.length = 0;
      lastSpawnObstacle = 0;
      lastSpawnPickup = 0;
      obstacleInterval = 1400;
      pickupInterval = 1000;
      lastFrameTime = performance.now();
      scoreLabel.textContent = "Score: 0";
      bestLabel.textContent = "Best: " + bestScore;
    }

    function spawnObstacle(now) {
      const typeRoll = Math.random();
      let type = "tray";
      let width = 55;
      let height = 35;
      let color = "#b27d51";

      if (typeRoll < 0.33) {
        type = "olive";
        width = 30;
        height = 30;
        color = "#8a9c4a";
      } else if (typeRoll < 0.66) {
        type = "flour";
        width = 46;
        height = 40;
        color = "#d2c6b3";
      }

      const ob = {
        x: GAME_WIDTH + 20,
        y: groundY - height,
        width,
        height,
        speed: 4.2,
        type,
        color
      };
      obstacles.push(ob);
      lastSpawnObstacle = now;
    }

    function spawnPickup(now) {
      const kind = Math.random() < 0.6 ? "karak" : "fatayer";
      const size = 34;
      const y = groundY - 90 - Math.random() * 60;

      const pk = {
        x: GAME_WIDTH + 20,
        y,
        size,
        speed: 4.2,
        kind
      };
      pickups.push(pk);
      lastSpawnPickup = now;
    }

    function rectsOverlap(ax, ay, aw, ah, bx, by, bw, bh) {
      return (
        ax < bx + bw &&
        ax + aw > bx &&
        ay < by + bh &&
        ay + ah > by
      );
    }

    function update(dt, now) {
      player.vy += gravity;
      player.y += player.vy;

      if (player.y + player.height >= groundY) {
        player.y = groundY - player.height;
        player.vy = 0;
        if (!player.onGround) {
          player.onGround = true;
          player.canDoubleJump = true;
        }
      }

      if (now - lastSpawnObstacle > obstacleInterval) {
        spawnObstacle(now);
        if (obstacleInterval > 900) obstacleInterval -= 20;
      }

      if (now - lastSpawnPickup > pickupInterval) {
        spawnPickup(now);
        if (pickupInterval > 700) pickupInterval -= 10;
      }

      for (let i = obstacles.length - 1; i >= 0; i--) {
        const ob = obstacles[i];
        ob.x -= ob.speed;
        if (ob.x + ob.width < -40) {
          obstacles.splice(i, 1);
        } else if (
          rectsOverlap(
            player.x,
            player.y,
            player.width,
            player.height,
            ob.x,
            ob.y,
            ob.width,
            ob.height
          )
        ) {
          gameOver();
          return;
        }
      }

      for (let i = pickups.length - 1; i >= 0; i--) {
        const pk = pickups[i];
        pk.x -= pk.speed;
        if (pk.x + pk.size < -30) {
          pickups.splice(i, 1);
        } else if (
          rectsOverlap(
            player.x,
            player.y,
            player.width,
            player.height,
            pk.x,
            pk.y,
            pk.size,
            pk.size
          )
        ) {
          score += pk.kind === "karak" ? 7 : 5;
          pickups.splice(i, 1);
          scoreLabel.textContent = "Score: " + score;
          if (score > bestScore) {
            bestScore = score;
            bestLabel.textContent = "Best: " + bestScore;
          }
        }
      }

      score += dt * 0.004;
      score = Math.floor(score);
      scoreLabel.textContent = "Score: " + score;
      if (score > bestScore) {
        bestScore = score;
        bestLabel.textContent = "Best: " + bestScore;
      }
    }

    function render() {
      ctx.clearRect(0, 0, GAME_WIDTH, GAME_HEIGHT);
      drawBackground();
      pickups.forEach(drawPickup);
      obstacles.forEach(drawObstacle);
      drawPlayer();
    }

    function loop(now) {
      if (gameState === STATE_PLAYING) {
        const dt = now - lastFrameTime;
        lastFrameTime = now;
        update(dt, now);
        render();
      } else {
        lastFrameTime = now;
        ctx.clearRect(0, 0, GAME_WIDTH, GAME_HEIGHT);
        drawBackground();
        drawPlayer();
      }
      requestAnimationFrame(loop);
    }

    // ===================== الشاشات =====================
    function showScreen(screen) {
      [startScreen, gameOverScreen].forEach((s) =>
        s.classList.remove("visible")
      );
      if (screen) screen.classList.add("visible");
    }

    function showHUD(show) {
      hud.style.display = show ? "flex" : "none";
      hint.style.display = show ? "block" : "none";
    }

    function goToMenu() {
      gameState = STATE_MENU;
      showScreen(startScreen);
      showHUD(false);
      startBestScoreLabel.textContent = bestScore;
    }

    function startPlaying() {
      resetGame();
      gameState = STATE_PLAYING;
      showScreen(null);
      showHUD(true);
    }

    function gameOver() {
      gameState = STATE_GAMEOVER;
      showHUD(false);
      localStorage.setItem(BEST_KEY, bestScore.toString());
      finalScoreLabel.textContent = score;
      finalBestScoreLabel.textContent = bestScore;
      showScreen(gameOverScreen);
    }

    // ===================== ربط الأزرار =====================
    startBtn.addEventListener("click", startPlaying);
    retryBtn.addEventListener("click", startPlaying);
    homeBtn.addEventListener("click", goToMenu);

    // بدء الحلقة
    startBestScoreLabel.textContent = bestScore;
    requestAnimationFrame(loop);
  </script>
</body>
</html>
