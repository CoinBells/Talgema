<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Talgema Run</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", Arial, sans-serif;
    }

    body {
      background: radial-gradient(circle at top, #222 0, #000 55%, #000 100%);
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      overflow: hidden;
      color: #222;
    }

    #game-wrapper {
      position: relative;
      width: 100%;
      max-width: 420px;
      aspect-ratio: 9 / 16;
      background: #000;
      border-radius: 24px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
      overflow: hidden;
    }

    canvas {
      width: 100%;
      height: 100%;
      display: block;
      background: transparent;
      touch-action: none; /* يمنع سكرول/زوم مع اللمس داخل اللعبة */
    }

    .screen {
      position: absolute;
      inset: 0;
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 20px;
      text-align: center;
      background: radial-gradient(circle at top, rgba(0, 0, 0, 0.25), rgba(0, 0, 0, 0.75));
      color: #f7f0e3;
      z-index: 3;
    }
    .screen.visible {
      display: flex;
    }

    /* شاشة البداية */
    #logoMain {
      width: 190px;
      max-width: 70%;
      height: auto;
      border-radius: 50%;
      box-shadow: 0 10px 25px rgba(0,0,0,0.45);
      margin-bottom: 18px;
    }

    .title-en-small {
      font-size: 13px;
      letter-spacing: 4px;
      text-transform: uppercase;
      margin-bottom: 8px;
      opacity: 0.85;
    }

    .btn {
      background: #f5e4c8;
      color: #252220;
      border-radius: 999px;
      padding: 10px 26px;
      font-size: 15px;
      margin: 10px 0 4px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      letter-spacing: 1px;
      box-shadow: 0 8px 14px rgba(0, 0, 0, 0.35);
      transition: transform 0.1s ease, box-shadow 0.1s ease, background 0.15s;
    }
    .btn:active {
      transform: translateY(1px) scale(0.98);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
      background: #f1ddc0;
    }

    .btn-secondary {
      background: #2b2623;
      color: #f5e4c8;
      box-shadow: 0 6px 10px rgba(0, 0, 0, 0.4);
    }
    .btn-secondary:active {
      background: #211d1a;
    }

    .score-box {
      font-size: 13px;
      margin-top: 8px;
      opacity: 0.9;
    }

    /* HUD أثناء اللعب */
    #hud {
      position: absolute;
      top: 10px;
      left: 0;
      right: 0;
      display: flex;
      justify-content: space-between;
      padding: 0 14px;
      font-size: 13px;
      color: #2b2623;
      text-shadow: 0 1px 2px rgba(255,255,255,0.6);
      pointer-events: none;
      z-index: 2;
    }

    /* رابط الانستقرام في أسفل الكرت */
    #igFooter {
      position: absolute;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 12px;
      color: #f5e4c8;
      background: rgba(0, 0, 0, 0.7);
      padding: 4px 14px;
      border-radius: 999px;
      cursor: pointer;
      z-index: 4;
      letter-spacing: 1px;
    }

    #igFooter:active {
      transform: translateX(-50%) scale(0.97);
      background: rgba(0, 0, 0, 0.85);
    }

    /* صورة اللاعب في شاشة النتيجة */
    #bakerThumb {
      position: absolute;
      bottom: 40px;
      left: 26px;
      width: 90px;
      opacity: 0.95;
    }
  </style>
</head>

<body>
  <div id="game-wrapper">
    <canvas id="gameCanvas"></canvas>

    <!-- HUD أثناء اللعب -->
    <div id="hud" style="display:none;">
      <div id="scoreLabel">Score: 0</div>
      <div id="bestLabel">Best: 0</div>
    </div>

    <!-- شاشة البداية -->
    <div id="startScreen" class="screen visible">
      <img id="logoMain" src="LOGO.PNG" alt="Talgema Logo" />
      <div class="title-en-small">TALGEMA RUN</div>
      <button id="startBtn" class="btn">START</button>
      <div class="score-box">
        BEST SCORE: <span id="startBestScore">0</span>
      </div>
    </div>

    <!-- شاشة النتيجة -->
    <div id="gameOverScreen" class="screen">
      <div class="title-en-small">ORDER ALMOST READY</div>
      <div class="score-box" style="margin-bottom:14px;">
        نتيجتك: <span id="finalScore">0</span><br/>
        أفضل نتيجة: <span id="finalBestScore">0</span>
      </div>
      <button id="retryBtn" class="btn">جولة جديدة</button>
      <button id="homeBtn" class="btn btn-secondary">الرجوع للرئيسية</button>
      <img id="bakerThumb" src="BAKER.PNG" alt="Baker" />
    </div>

    <!-- رابط الانستقرام -->
    <div id="igFooter">Talgema</div>
  </div>

  <script>
    "use strict";

    // ============ إعداد الكانفس ============

    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    const GAME_WIDTH = 360;
    const GAME_HEIGHT = 640;

    const dpr = window.devicePixelRatio || 1;
    canvas.width = GAME_WIDTH * dpr;
    canvas.height = GAME_HEIGHT * dpr;
    canvas.style.width = GAME_WIDTH + "px";
    canvas.style.height = GAME_HEIGHT + "px";
    ctx.scale(dpr, dpr);

    // ============ تحميل الصور ============

    const bakerImg = new Image();
    bakerImg.src = "BAKER.PNG";
    let bakerLoaded = false;
    bakerImg.onload = () => bakerLoaded = true;

    const karakImg = new Image();
    karakImg.src = "KARAK.PNG";
    let karakLoaded = false;
    karakImg.onload = () => karakLoaded = true;

    const fatayerImg = new Image();
    fatayerImg.src = "fatayer.jpg";

    // ============ عناصر الواجهة ============

    const wrapper = document.getElementById("game-wrapper");
    const startScreen = document.getElementById("startScreen");
    const gameOverScreen = document.getElementById("gameOverScreen");
    const startBtn = document.getElementById("startBtn");
    const retryBtn = document.getElementById("retryBtn");
    const homeBtn = document.getElementById("homeBtn");
    const hud = document.getElementById("hud");
    const scoreLabel = document.getElementById("scoreLabel");
    const bestLabel = document.getElementById("bestLabel");
    const startBestScoreLabel = document.getElementById("startBestScore");
    const finalScoreLabel = document.getElementById("finalScore");
    const finalBestScoreLabel = document.getElementById("finalBestScore");
    const igFooter = document.getElementById("igFooter");

    igFooter.addEventListener("click", () => {
      window.open(
        "https://www.instagram.com/talgema.kw?igsh=MWR3cmZiOWRkbWxybg==",
        "_blank"
      );
    });

    // ============ حالة اللعبة ============

    const STATE_MENU = "menu";
    const STATE_PLAYING = "playing";
    const STATE_GAMEOVER = "gameover";
    let gameState = STATE_MENU;

    // ============ السكور ============

    let score = 0;
    const BEST_KEY = "talgema_run_best_score";
    let bestScore = parseInt(localStorage.getItem(BEST_KEY) || "0", 10);

    // ============ اللاعب والعالم ============

    const groundY = GAME_HEIGHT - 120;

    const player = {
      x: 90,
      y: groundY - 80,
      width: 40,
      height: 80,
      vy: 0,
      onGround: true
    };

    const gravity = 0.6;
    const jumpVelocity = -11;

    const obstacles = [];
    const pickups = [];

    let lastSpawnObstacle = 0;
    let lastSpawnPickup = 0;
    let obstacleInterval = 1400;
    let pickupInterval = 1100;

    let lastFrameTime = performance.now();

    // ============ إدخال (قفز ضغطة واحدة) ============

    function jump() {
      if (gameState !== STATE_PLAYING) return;
      if (player.onGround) {
        player.vy = jumpVelocity;
        player.onGround = false;
      }
    }

    function handlePointerDown(e) {
      if (gameState === STATE_PLAYING) {
        e.preventDefault();
        jump();
      }
    }

    canvas.addEventListener("touchstart", handlePointerDown, { passive: false });
    canvas.addEventListener("mousedown", handlePointerDown);
    wrapper.addEventListener("touchstart", handlePointerDown, { passive: false });

    window.addEventListener("keydown", (e) => {
      if (e.code === "Space") {
        e.preventDefault();
        jump();
      }
    });

    // ============ رسم الخلفية ============

    function drawBackground() {
      // صورة الفطائر تغطي كامل الشاشة (cover)
      if (fatayerImg.complete && fatayerImg.naturalWidth > 0) {
        const iw = fatayerImg.width;
        const ih = fatayerImg.height;
        const scale = Math.max(GAME_WIDTH / iw, GAME_HEIGHT / ih);
        const w = iw * scale;
        const h = ih * scale;
        const x = (GAME_WIDTH - w) / 2;
        const y = (GAME_HEIGHT - h) / 2;

        ctx.drawImage(fatayerImg, x, y, w, h);
      } else {
        ctx.fillStyle = "#f3e0c3";
        ctx.fillRect(0, 0, GAME_WIDTH, GAME_HEIGHT);
      }

      // طبقة تدرّج خفيفة لتوضيح النصوص واللاعب
      const grad = ctx.createLinearGradient(0, 0, 0, GAME_HEIGHT);
      grad.addColorStop(0, "rgba(243, 224, 195, 0.65)");
      grad.addColorStop(0.6, "rgba(243, 224, 195, 0.4)");
      grad.addColorStop(1, "rgba(243, 224, 195, 0.9)");
      ctx.fillStyle = grad;
      ctx.fillRect(0, 0, GAME_WIDTH, GAME_HEIGHT);

      // أرضية شبه شفافة فوق الخلفية
      ctx.save();
      ctx.globalAlpha = 0.9;
      ctx.fillStyle = "#e1c296";
      ctx.fillRect(0, groundY, GAME_WIDTH, GAME_HEIGHT - groundY);
      ctx.restore();
    }

    // ============ رسم اللاعب ============

    function drawPlayer() {
      // ظل ثابت على الأرض
      ctx.fillStyle = "rgba(0,0,0,0.22)";
      ctx.beginPath();
      ctx.ellipse(
        player.x + player.width / 2,
        groundY + 4,
        20,
        7,
        0,
        0,
        Math.PI * 2
      );
      ctx.fill();

      const feetY = player.y + player.height;

      if (bakerLoaded) {
        const spriteHeight = 190;
        const spriteWidth = spriteHeight * (bakerImg.width / bakerImg.height);
        const drawX = player.x - (spriteWidth - player.width) / 2;
        const drawY = feetY - spriteHeight;
        ctx.drawImage(bakerImg, drawX, drawY, spriteWidth, spriteHeight);
      } else {
        ctx.fillStyle = "#d3b791";
        ctx.fillRect(player.x, player.y, player.width, player.height);
      }
    }

    // ============ العوائق و الكرك / الفطائر ============

    function roundRect(ctx, x, y, w, h, r) {
      if (w < 2 * r) r = w / 2;
      if (h < 2 * r) r = h / 2;
      ctx.beginPath();
      ctx.moveTo(x + r, y);
      ctx.arcTo(x + w, y, x + w, y + h, r);
      ctx.arcTo(x + w, y + h, x, y + h, r);
      ctx.arcTo(x, y + h, x, y, r);
      ctx.arcTo(x, y, x + w, y, r);
      ctx.closePath();
    }

    function drawObstacle(ob) {
      ctx.fillStyle = ob.color;
      roundRect(ctx, ob.x, ob.y, ob.width, ob.height, 10);
      ctx.fill();

      ctx.fillStyle = "rgba(0,0,0,0.15)";
      if (ob.type === "tray") {
        ctx.fillRect(ob.x + 8, ob.y + 8, ob.width - 16, 7);
      } else if (ob.type === "olive") {
        ctx.beginPath();
        ctx.arc(
          ob.x + ob.width / 2,
          ob.y + ob.height / 2,
          ob.width / 2.3,
          0,
          Math.PI * 2
        );
        ctx.fill();
      } else if (ob.type === "flour") {
        ctx.fillRect(ob.x + 6, ob.y + 6, ob.width - 12, ob.height - 14);
      }
    }

    function drawPickup(pk) {
      const size = pk.size;
      const centerX = pk.x + size / 2;
      const centerY = pk.y + size / 2;

      if (pk.kind === "karak" && karakLoaded) {
        // كوب الكرك بشعار تلقيمة
        const aspect = karakImg.height / karakImg.width;
        const w = size;
        const h = size * aspect;
        const drawX = centerX - w / 2;
        const drawY = centerY - h / 2;
        ctx.drawImage(karakImg, drawX, drawY, w, h);
      } else {
        // فطيرة صغيرة
        ctx.fillStyle = "#f1d2a4";
        ctx.beginPath();
        ctx.ellipse(centerX, centerY, 16, 11, 0, 0, Math.PI * 2);
        ctx.fill();

        ctx.fillStyle = "#d08b3f";
        ctx.beginPath();
        ctx.ellipse(centerX, centerY, 10, 6, 0, 0, Math.PI * 2);
        ctx.fill();
      }
    }

    // ============ لوجيك اللعبة ============

    function resetGame() {
      score = 0;
      player.x = 90;
      player.y = groundY - player.height;
      player.vy = 0;
      player.onGround = true;

      obstacles.length = 0;
      pickups.length = 0;

      lastSpawnObstacle = 0;
      lastSpawnPickup = 0;
      obstacleInterval = 1400;
      pickupInterval = 1100;

      lastFrameTime = performance.now();
      scoreLabel.textContent = "Score: 0";
      bestLabel.textContent = "Best: " + bestScore;
    }

    function spawnObstacle(now) {
      const typeRoll = Math.random();
      let type = "tray";
      let width = 72;
      let height = 44;
      let color = "#b27d51";

      if (typeRoll < 0.33) {
        type = "olive";
        width = 42;
        height = 42;
        color = "#8a9c4a";
      } else if (typeRoll < 0.66) {
        type = "flour";
        width = 60;
        height = 50;
        color = "#d2c6b3";
      }

      const ob = {
        x: GAME_WIDTH + 20,
        y: groundY - height,
        width,
        height,
        speed: 4.3,
        type,
        color
      };
      obstacles.push(ob);
      lastSpawnObstacle = now;
    }

    function spawnPickup(now) {
      const kind = Math.random() < 0.8 ? "karak" : "fatayer"; // أغلب الوقت كرك
      const size = 50;
      const y = groundY - 110 - Math.random() * 60;

      const pk = {
        x: GAME_WIDTH + 20,
        y,
        size,
        speed: 4.3,
        kind
      };
      pickups.push(pk);
      lastSpawnPickup = now;
    }

    function rectsOverlap(ax, ay, aw, ah, bx, by, bw, bh) {
      return (
        ax < bx + bw &&
        ax + aw > bx &&
        ay < by + bh &&
        ay + ah > by
      );
    }

    function update(dt, now) {
      // فيزياء اللاعب
      player.vy += gravity;
      player.y += player.vy;

      if (player.y + player.height >= groundY) {
        player.y = groundY - player.height;
        player.vy = 0;
        if (!player.onGround) {
          player.onGround = true;
        }
      }

      // توليد العوائق والـ pickups
      if (now - lastSpawnObstacle > obstacleInterval) {
        spawnObstacle(now);
        if (obstacleInterval > 950) obstacleInterval -= 20;
      }

      if (now - lastSpawnPickup > pickupInterval) {
        spawnPickup(now);
        if (pickupInterval > 800) pickupInterval -= 15;
      }

      // تحريك العوائق
      for (let i = obstacles.length - 1; i >= 0; i--) {
        const ob = obstacles[i];
        ob.x -= ob.speed;
        if (ob.x + ob.width < -40) {
          obstacles.splice(i, 1);
        } else if (
          rectsOverlap(
            player.x,
            player.y,
            player.width,
            player.height,
            ob.x,
            ob.y,
            ob.width,
            ob.height
          )
        ) {
          gameOver();
          return;
        }
      }

      // تحريك الكرك / الفطاير
      for (let i = pickups.length - 1; i >= 0; i--) {
        const pk = pickups[i];
        pk.x -= pk.speed;
        if (pk.x + pk.size < -30) {
          pickups.splice(i, 1);
        } else if (
          rectsOverlap(
            player.x,
            player.y,
            player.width,
            player.height,
            pk.x,
            pk.y,
            pk.size,
            pk.size
          )
        ) {
          score += pk.kind === "karak" ? 7 : 5;
          pickups.splice(i, 1);
          scoreLabel.textContent = "Score: " + score;
          if (score > bestScore) {
            bestScore = score;
            bestLabel.textContent = "Best: " + bestScore;
          }
        }
      }

      // زيادة بسيطة في السكور مع الوقت
      score += dt * 0.004;
      score = Math.floor(score);
      scoreLabel.textContent = "Score: " + score;
      if (score > bestScore) {
        bestScore = score;
        bestLabel.textContent = "Best: " + bestScore;
      }
    }

    function render() {
      ctx.clearRect(0, 0, GAME_WIDTH, GAME_HEIGHT);
      drawBackground();
      pickups.forEach(drawPickup);
      obstacles.forEach(drawObstacle);
      drawPlayer();
    }

    // ============ حلقة اللعبة ============

    function loop(now) {
      if (gameState === STATE_PLAYING) {
        const dt = now - lastFrameTime;
        lastFrameTime = now;
        update(dt, now);
        render();
      } else {
        lastFrameTime = now;
        ctx.clearRect(0, 0, GAME_WIDTH, GAME_HEIGHT);
        drawBackground();
        drawPlayer();
      }
      requestAnimationFrame(loop);
    }

    // ============ الشاشات ============

    function showScreen(screen) {
      startScreen.classList.remove("visible");
      gameOverScreen.classList.remove("visible");
      if (screen) screen.classList.add("visible");
    }

    function showHUD(show) {
      hud.style.display = show ? "flex" : "none";
    }

    function goToMenu() {
      gameState = STATE_MENU;
      showScreen(startScreen);
      showHUD(false);
      startBestScoreLabel.textContent = bestScore;
    }

    function startPlaying() {
      resetGame();
      gameState = STATE_PLAYING;
      showScreen(null);
      showHUD(true);
    }

    function gameOver() {
      gameState = STATE_GAMEOVER;
      showHUD(false);
      localStorage.setItem(BEST_KEY, bestScore.toString());
      finalScoreLabel.textContent = score;
      finalBestScoreLabel.textContent = bestScore;
      showScreen(gameOverScreen);
    }

    // ============ ربط الأزرار ============

    startBtn.addEventListener("click", startPlaying);
    retryBtn.addEventListener("click", startPlaying);
    homeBtn.addEventListener("click", goToMenu);

    // ============ بدء اللعبة ============

    startBestScoreLabel.textContent = bestScore;
    requestAnimationFrame(loop);
  </script>
</body>
</html>
